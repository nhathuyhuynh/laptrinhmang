<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System - ƒêƒÉng nh·∫≠p</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
    
    <style>
        /* === TH√äM CSS CHO TH√îNG B√ÅO (TOAST) === */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            min-width: 250px; margin-bottom: 10px; padding: 15px 20px;
            border-radius: 8px; color: white; font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center;
            animation: slideIn 0.3s ease, fadeOut 0.5s 3s forwards; opacity: 1;
        }
        .toast.error { background: #e53e3e; border-left: 5px solid #9b2c2c; }
        .toast.success { background: #48bb78; border-left: 5px solid #2f855a; }
        .toast-icon { margin-right: 10px; font-size: 1.2rem; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>
    <div id="toast-box"></div>

    <div class="container">
        <div class="card">
            <h1 class="logo">üîê ƒêƒÉng nh·∫≠p</h1>
            <p class="subtitle">Ch√†o m·ª´ng tr·ªü l·∫°i!</p>
            
            <form id="login-form" onsubmit="return false;">
                
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" class="input" placeholder="Nh·∫≠p username..." autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autocomplete="current-password">
                </div>
                
                <div class="demo-account">
                    <h4>T√†i kho·∫£n demo:</h4>
                    <p><strong>Username:</strong> admin</p>
                    <p><strong>Password:</strong> admin123</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <button type="submit" class="btn btn-primary" id="login-btn">
                        <span>üöÄ</span> ƒêƒÉng nh·∫≠p
                    </button>
                </div>

            </form>
            <div style="margin-top: 20px;">
                <p>Ch∆∞a c√≥ t√†i kho·∫£n? 
                    <span class="link" onclick="location.href='register.html'">ƒêƒÉng k√Ω ngay</span>
                </p>
                <p>
                    <span class="link" onclick="location.href='index.html'">‚Üê Quay l·∫°i trang ch·ªß</span>
                </p>
            </div>
        </div>
    </div>
    
    <script>
        // 1. D·ªçn d·∫πp session c≈© ƒë·ªÉ tr√°nh l·ªói
        sessionStorage.clear();
        localStorage.clear();

        let ws = null;
        let isProcessing = false; // "Ch·ªët kh√≥a" ch·ªëng click ƒë√∫p

        // === H√ÄM HI·ªÜN TH√îNG B√ÅO ===
        function showToast(message, type = 'error') {
            const box = document.getElementById('toast-box');
            const toast = document.createElement('div');
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
            box.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // === K·∫æT N·ªêI WEBSOCKET ===
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return ws;
            }
            ws = new WebSocket('ws://localhost:8765');
            
            ws.onopen = () => console.log('‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi server');
            ws.onclose = () => {
                console.log('üì° ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                setTimeout(connectWebSocket, 1000); // Th·ª≠ k·∫øt n·ªëi l·∫°i
            };
            return ws;
        }
        
        // === H√ÄM X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ===
        function handleLogin(e) {
            // Ch·∫∑n load l·∫°i trang m·∫∑c ƒë·ªãnh
            if(e) e.preventDefault();

            // N·∫øu ƒëang x·ª≠ l√Ω r·ªìi th√¨ D·ª™NG L·∫†I NGAY (Fix l·ªói 2 th√¥ng b√°o)
            if (isProcessing) return;

            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();

            if (!u || !p) {
                showToast("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error");
                return;
            }

            // --- B·∫ÆT ƒê·∫¶U KH√ìA ---
            isProcessing = true;
            const btn = document.getElementById('login-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> ƒêang k·∫øt n·ªëi...';
            btn.disabled = true;

            const socket = connectWebSocket();
            
            // H√†m g·ª≠i d·ªØ li·ªáu
            const sendData = () => {
                socket.send(JSON.stringify({
                    type: 'login',
                    username: u,
                    password: p,
                    room: 'general'
                }));
            };

            if (socket.readyState === WebSocket.OPEN) {
                sendData();
            } else {
                socket.onopen = sendData;
                socket.onerror = () => {
                    showToast("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Server!", "error");
                    resetButton(btn, originalText);
                };
            }

            // Nh·∫≠n ph·∫£n h·ªìi
            socket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'login_success') {
                        showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
                        
                        // D√πng sessionStorage ƒë·ªÉ bu·ªôc ƒëƒÉng nh·∫≠p l·∫°i khi t·∫Øt tr√¨nh duy·ªát
                        sessionStorage.setItem('username', data.username);
                        sessionStorage.setItem('role', data.role);
                        
                        // Ch·ªù 1s r·ªìi chuy·ªÉn trang
                        setTimeout(() => window.location.href = 'chat.html', 1000);
                        
                    } else if (data.type === 'login_fail' || data.type === 'error') {
                        showToast(data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i', "error");
                        resetButton(btn, originalText);
                    }
                } catch (err) {
                    console.error('L·ªói:', err);
                    resetButton(btn, originalText);
                }
            };
        }

        function resetButton(btn, originalText) {
            isProcessing = false; // M·ªü kh√≥a
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        // === G√ÅN S·ª∞ KI·ªÜN SUBMIT FORM ===
        // Ch·ªâ c·∫ßn d√≤ng n√†y l√† x·ª≠ l√Ω c·∫£ Enter l·∫´n Click n√∫t
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // Focus v√†o √¥ username khi v√†o trang
        document.getElementById('username').focus();
        
        // Kh·ªüi t·∫°o k·∫øt n·ªëi ng·∫ßm
        connectWebSocket();
    </script>
</body>
</html>