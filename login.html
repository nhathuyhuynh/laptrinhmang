<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System - ƒêƒÉng nh·∫≠p</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="logo">üîê ƒêƒÉng nh·∫≠p</h1>
            <p class="subtitle">Ch√†o m·ª´ng tr·ªü l·∫°i!</p>
            
            <div class="form-group">
                <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="username" class="input" placeholder="Nh·∫≠p username..." autocomplete="username">
                <div id="username-error" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u</label>
                <input type="password" id="password" class="input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autocomplete="current-password">
                <div id="password-error" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="demo-account">
                <h4>T√†i kho·∫£n demo:</h4>
                <p><strong>Username:</strong> admin</p>
                <p><strong>Password:</strong> admin123</p>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="login()" id="login-btn">
                    <span>üöÄ</span> ƒêƒÉng nh·∫≠p
                </button>
                <div id="loading" style="display: none; margin-top: 10px;">
                    <div class="loading"></div> ƒêang k·∫øt n·ªëi...
                </div>
            </div>
            
            <div id="error-message" class="error-message" style="display: none; margin: 10px 0;"></div>
            
            <div style="margin-top: 20px;">
                <p>Ch∆∞a c√≥ t√†i kho·∫£n? 
                    <span class="link" onclick="location.href='register.html'">ƒêƒÉng k√Ω ngay</span>
                </p>
                <p>
                    <span class="link" onclick="location.href='index.html'">‚Üê Quay l·∫°i trang ch·ªß</span>
                </p>
            </div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let isLoading = false;
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        function showLoading() {
            isLoading = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('login-btn').disabled = true;
        }
        
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('login-btn').disabled = false;
        }
        
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return ws;
            }
            
            ws = new WebSocket('ws://localhost:8765');
            
            ws.onopen = function() {
                console.log('‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi server');
                document.getElementById('error-message').style.display = 'none';
            };
            
            ws.onerror = function(error) {
                console.error('‚ùå L·ªói k·∫øt n·ªëi:', error);
                showError('error-message', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. H√£y ch·∫°y server.py tr∆∞·ªõc!');
                hideLoading();
            };
            
            ws.onclose = function() {
                console.log('üì° ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                if (isLoading) {
                    setTimeout(connectWebSocket, 1000);
                }
            };
            
            ws.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'login_success') {
                        hideLoading();
                        
                        // L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p
                        localStorage.setItem('username', data.username);
                        localStorage.setItem('role', data.role);
                        localStorage.setItem('room', data.room);
                        
                        // Chuy·ªÉn ƒë·∫øn trang chat
                        window.location.href = 'chat.html';
                        
                    } else if (data.type === 'login_fail') {
                        hideLoading();
                        showError('error-message', data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
                        
                    } else if (data.type === 'error') {
                        hideLoading();
                        showError('error-message', data.message);
                    }
                    
                } catch (err) {
                    console.error('L·ªói parse JSON:', err);
                }
            };
            
            return ws;
        }
        
        function login() {
            // Reset l·ªói
            hideError('username-error');
            hideError('password-error');
            hideError('error-message');
            
            // L·∫•y gi√° tr·ªã
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Validate
            let hasError = false;
            
            if (!username) {
                showError('username-error', 'Vui l√≤ng nh·∫≠p username');
                hasError = true;
            }
            
            if (!password) {
                showError('password-error', 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Hi·ªÉn th·ªã loading
            showLoading();
            
            // K·∫øt n·ªëi WebSocket v√† g·ª≠i login
            const socket = connectWebSocket();
            
            // G·ª≠i sau khi k·∫øt n·ªëi th√†nh c√¥ng
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'login',
                    username: username,
                    password: password,
                    room: 'general'
                }));
            } else {
                socket.onopen = function() {
                    socket.send(JSON.stringify({
                        type: 'login',
                        username: username,
                        password: password,
                        room: 'general'
                    }));
                };
            }
        }
        
        // Cho ph√©p nh·∫•n Enter ƒë·ªÉ ƒëƒÉng nh·∫≠p
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // T·ª± ƒë·ªông focus v√†o username
        document.getElementById('username').focus();
        
        // K·∫øt n·ªëi WebSocket khi trang load
        connectWebSocket();
    </script>
</body>
</html>