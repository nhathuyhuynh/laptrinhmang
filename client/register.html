<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System - ƒêƒÉng k√Ω</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="logo">üìù ƒêƒÉng k√Ω</h1>
            <p class="subtitle">T·∫°o t√†i kho·∫£n m·ªõi</p>
            
            <div class="form-group">
                <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="username" class="input" placeholder="T·ª´ 3-20 k√Ω t·ª±" autocomplete="username">
                <div id="username-error" class="error-message" style="display: none;"></div>
                <p class="hint">Ch·ªâ ch·ª©a ch·ªØ c√°i, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi</p>
            </div>
            
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u</label>
                <input type="password" id="password" class="input" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" autocomplete="new-password">
                <div id="password-error" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="form-group">
                <label for="confirm-password">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <input type="password" id="confirm-password" class="input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" autocomplete="new-password">
                <div id="confirm-error" class="error-message" style="display: none;"></div>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="register()" id="register-btn">
                    <span>‚úÖ</span> ƒêƒÉng k√Ω
                </button>
                <div id="loading" style="display: none; margin-top: 10px;">
                    <div class="loading"></div> ƒêang x·ª≠ l√Ω...
                </div>
            </div>
            
            <div id="success-message" class="success-message" style="display: none; margin: 10px 0; padding: 10px; background: #d4edda; color: #155724; border-radius: 5px;"></div>
            <div id="error-message" class="error-message" style="display: none; margin: 10px 0;"></div>
            
            <div style="margin-top: 20px;">
                <p>ƒê√£ c√≥ t√†i kho·∫£n? 
                    <span class="link" onclick="location.href='login.html'">ƒêƒÉng nh·∫≠p ngay</span>
                </p>
                <p>
                    <span class="link" onclick="location.href='index.html'">‚Üê Quay l·∫°i trang ch·ªß</span>
                </p>
            </div>
            
            <div class="demo-account" style="margin-top: 30px;">
                <h4>L∆∞u √Ω:</h4>
                <p>‚Ä¢ Username ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±</p>
                <p>‚Ä¢ M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±</p>
                <p>‚Ä¢ Kh√¥ng s·ª≠ d·ª•ng th√¥ng tin c√° nh√¢n quan tr·ªçng</p>
            </div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let isLoading = false;
        
        // Th√™m style cho hint
        const style = document.createElement('style');
        style.textContent = `
            .hint {
                font-size: 0.8rem;
                color: var(--gray);
                margin-top: 5px;
            }
            .success-message {
                background: #d4edda;
                color: #155724;
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
            }
        `;
        document.head.appendChild(style);
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        function showSuccess(message) {
            const element = document.getElementById('success-message');
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }
        
        function showLoading() {
            isLoading = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('register-btn').disabled = true;
        }
        
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('register-btn').disabled = false;
        }
        
        function validateForm() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            
            let isValid = true;
            
            // Validate username
            hideError('username-error');
            if (!username) {
                showError('username-error', 'Vui l√≤ng nh·∫≠p username');
                isValid = false;
            } else if (username.length < 3) {
                showError('username-error', 'Username ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
                isValid = false;
            } else if (username.length > 20) {
                showError('username-error', 'Username t·ªëi ƒëa 20 k√Ω t·ª±');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showError('username-error', 'Username ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi');
                isValid = false;
            }
            
            // Validate password
            hideError('password-error');
            if (!password) {
                showError('password-error', 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
                isValid = false;
            } else if (password.length < 6) {
                showError('password-error', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
                isValid = false;
            }
            
            // Validate confirm password
            hideError('confirm-error');
            if (!confirmPassword) {
                showError('confirm-error', 'Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirm-error', 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp');
                isValid = false;
            }
            
            return isValid;
        }
        
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return ws;
            }
            
            ws = new WebSocket('ws://localhost:8765');
            
            ws.onopen = function() {
                console.log('‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi server');
                document.getElementById('error-message').style.display = 'none';
            };
            
            ws.onerror = function(error) {
                console.error('‚ùå L·ªói k·∫øt n·ªëi:', error);
                showError('error-message', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. H√£y ch·∫°y server.py tr∆∞·ªõc!');
                hideLoading();
            };
            
            ws.onclose = function() {
                console.log('üì° ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                if (isLoading) {
                    setTimeout(connectWebSocket, 1000);
                }
            };
            
            ws.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'register_ok') {
                        hideLoading();
                        showSuccess(data.message || '‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng!');
                        
                        // Chuy·ªÉn ƒë·∫øn trang login sau 2 gi√¢y
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        
                    } else if (data.type === 'error') {
                        hideLoading();
                        showError('error-message', data.message);
                    }
                    
                } catch (err) {
                    console.error('L·ªói parse JSON:', err);
                }
            };
            
            return ws;
        }
        
        function register() {
            // Reset messages
            hideError('error-message');
            document.getElementById('success-message').style.display = 'none';
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            showLoading();
            
            // L·∫•y gi√° tr·ªã
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // K·∫øt n·ªëi WebSocket
            const socket = connectWebSocket();
            
            // G·ª≠i request ƒëƒÉng k√Ω
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'register',
                    username: username,
                    password: password
                }));
            } else {
                socket.onopen = function() {
                    socket.send(JSON.stringify({
                        type: 'register',
                        username: username,
                        password: password
                    }));
                };
            }
        }
        
        // Auto focus username
        document.getElementById('username').focus();
        
        // Cho ph√©p nh·∫•n Enter ƒë·ªÉ ƒëƒÉng k√Ω
        document.getElementById('confirm-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                register();
            }
        });
        
        // K·∫øt n·ªëi WebSocket khi trang load
        connectWebSocket();
        
        // Live validation
        document.getElementById('username').addEventListener('input', function() {
            hideError('username-error');
        });
        
        document.getElementById('password').addEventListener('input', function() {
            hideError('password-error');
            hideError('confirm-error');
        });
        
        document.getElementById('confirm-password').addEventListener('input', function() {
            hideError('confirm-error');
        });
    </script>
</body>
</html>