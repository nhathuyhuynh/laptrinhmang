<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ph√≤ng Chat</title>
<style>
/* --- CSS GI·ªÆ NGUY√äN NH∆Ø C≈® --- */
body{margin:0;height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#667eea,#764ba2);font-family:sans-serif}
.app{width:900px;height:550px;background:white;display:flex;border-radius:12px;overflow:hidden;box-shadow:0 0 20px rgba(0,0,0,0.2)}
.sidebar{width:220px;background:#f3f4f6;padding:15px;display:flex;flex-direction:column;border-right:1px solid #ddd}
.room-list{flex:1;overflow-y:auto; margin-bottom: 10px;}
.room-list ul{padding:0;margin:0}
.room-list li{list-style:none;padding:10px;cursor:pointer;border-radius:6px;margin-bottom:5px;font-weight:500;color:#555;transition:0.2s}
.room-list li:hover{background:#e0e0e0}
.room-list li.active{background:#667eea;color:white}
.add-room-area {display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 15px;}
.add-room-area input {width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; outline: none; font-size: 13px;}
.add-room-area button {background: #2ed573; color: white; border: none; padding: 0 12px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 18px;}
.add-room-area button:hover { background: #26af61; }
.logout-btn {background: #ff4757; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;}
.logout-btn:hover { background: #e84118; }
.chat{flex:1;display:flex;flex-direction:column}
.header{padding:15px;background:#667eea;color:white;font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between;}
.messages{flex:1;padding:15px;display:flex;flex-direction:column;overflow-y:auto;background:#fff}
.message{max-width:70%;padding:10px 14px;border-radius:15px;margin-bottom:8px;font-size:14px;line-height:1.4;word-wrap: break-word;}
.me{align-self:flex-end;background:#667eea;color:white;border-bottom-right-radius:2px}
.other{align-self:flex-start;background:#eee;color:#333;border-bottom-left-radius:2px}
.sender{font-size:11px;opacity:0.8;margin-bottom:4px;font-weight:bold}
.input{display:flex;padding:15px;border-top:1px solid #eee; background: #fff;}
input#msg{flex:1;padding:12px;border:1px solid #ddd;border-radius:20px;outline:none}
input#msg:focus{border-color:#667eea}
button.send-btn{margin-left:10px;padding:0 20px;background:#667eea;color:white;border:none;border-radius:20px;cursor:pointer;font-weight:bold}
button.send-btn:hover{background:#5a67d8}
</style>
</head>
<body>

<script>
const username = sessionStorage.getItem("username");
const logged = sessionStorage.getItem("logged");
if(!username || logged !== "true") location = "login.html";
</script>

<div class="app">
    <div class="sidebar">
        <h3>üìÇ Danh s√°ch ph√≤ng</h3>
        <div class="add-room-area">
            <input id="newRoomName" placeholder="T√™n ph√≤ng m·ªõi..." onkeydown="if(event.key==='Enter') createRoom()">
            <button onclick="createRoom()" title="T·∫°o ph√≤ng">+</button>
        </div>
        <div class="room-list">
            <ul id="rooms">
                <li class="active" onclick="switchRoom('general')"># general</li>
                <li onclick="switchRoom('study')"># study</li>
                <li onclick="switchRoom('game')"># game</li>
            </ul>
        </div>
        <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="chat">
        <div class="header">
            <span>üìå Ph√≤ng: <b id="roomNameDisplay">...</b></span>
            <span>üë§ <b id="user">...</b> | üü¢ <span id="online">0</span></span>
        </div>
        <div class="messages" id="messages"></div>
        <div class="input">
            <input id="msg" placeholder="Nh·∫≠p tin nh·∫Øn..." autofocus>
            <button class="send-btn" onclick="send()">G·ª≠i ‚û§</button>
        </div>
    </div>
</div>

<script>
// --- KH·ªûI T·∫†O T·ª™ SESSION STORAGE ---
document.getElementById("user").innerText = username;
let room = sessionStorage.getItem("room") || "general"; // L·∫•y t·ª´ session
let ws = new WebSocket("ws://localhost:8765");
let store = {};

function updateRoomUI(r){
    document.getElementById("roomNameDisplay").innerText = r;
    document.querySelectorAll(".room-list li").forEach(li => li.classList.remove("active"));
    let exist = [...document.querySelectorAll(".room-list li")].find(li => li.innerText === "# " + r);
    if(exist){
        exist.classList.add("active");
    } else {
        const ul = document.getElementById("rooms");
        const li = document.createElement("li");
        li.innerText = "# " + r;
        li.onclick = () => switchRoom(r);
        li.classList.add("active");
        ul.prepend(li);
    }
}

ws.onopen = ()=>{
    ws.send(JSON.stringify({ type:"login", username, room }));
    updateRoomUI(room);
};

ws.onmessage = e=>{
    const d = JSON.parse(e.data);
    if(d.type === "login_success" || d.type === "switched"){
        store[room] = d.history || [];
        document.getElementById("online").innerText = d.online;
        render();
    }
    if(d.type === "message"){
        if(!store[d.room]) store[d.room] = [];
        store[d.room].push({ sender: d.sender, message: d.message });
        if(d.room === room) add(d.sender, d.message);
    }
    if(d.type === "online"){
        document.getElementById("online").innerText = d.online;
    }
};

function add(sender, text){
    const div = document.createElement("div");
    div.className = "message " + (sender === username ? "me":"other");
    let content = sender === username ? `<div>${text}</div>` : `<div class="sender">${sender}</div><div>${text}</div>`;
    div.innerHTML = content;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function render(){
    messages.innerHTML="";
    (store[room]||[]).forEach(m=>add(m.sender,m.message));
}

function send(){
    const t = msg.value.trim();
    if(!t) return;
    ws.send(JSON.stringify({ type:"message", message:t }));
    msg.value="";
    msg.focus();
}

msg.addEventListener("keydown",e=>{ if(e.key==="Enter") send(); });

function switchRoom(r){
    if(r===room) return;
    room=r;
    sessionStorage.setItem("room",r); // L∆∞u v√†o session
    updateRoomUI(r);
    ws.send(JSON.stringify({type:"switch_room",room:r}));
}

function createRoom(){
    const input = document.getElementById("newRoomName");
    const name = input.value.trim().toLowerCase().replace(/\s+/g, '-');
    if(!name){ alert("Vui l√≤ng nh·∫≠p t√™n ph√≤ng!"); return; }
    if(name === room) return;
    switchRoom(name);
    input.value = "";
}

function logout(){
    if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")){
        sessionStorage.clear(); // X√≥a session
        ws.close();
        location = "login.html";
    }
}
</script>

</body>
</html>