<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>PhÃ²ng Chat</title>
<style>
/* CSS CÆ  Báº¢N */
body{margin:0;height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#667eea,#764ba2);font-family:sans-serif}
.app{width:900px;height:550px;background:white;display:flex;border-radius:12px;overflow:hidden;box-shadow:0 0 20px rgba(0,0,0,0.2)}

/* SIDEBAR */
.sidebar{width:200px;background:#f3f4f6;padding:10px;display:flex;flex-direction:column;justify-content:space-between}
.sidebar ul{padding:0}
.sidebar li{list-style:none;padding:12px;cursor:pointer;border-radius:6px;margin-bottom:5px;font-weight:500;color:#555}
.sidebar li:hover{background:#e0e0e0}
.sidebar li.active{background:#667eea;color:white}

/* LOGOUT BUTTON */
.logout-btn {
    background: #ff4757; color: white; border: none; padding: 10px;
    border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;
    margin-top: auto; /* Äáº©y xuá»‘ng Ä‘Ã¡y */
}
.logout-btn:hover { background: #e84118; }

/* CHAT AREA */
.chat{flex:1;display:flex;flex-direction:column}
.header{padding:15px;background:#667eea;color:white;font-size:16px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.messages{flex:1;padding:15px;display:flex;flex-direction:column;overflow-y:auto;background:#fff}
.message{max-width:65%;padding:10px 14px;border-radius:15px;margin-bottom:8px;font-size:14px;line-height:1.4}
.me{align-self:flex-end;background:#667eea;color:white;border-bottom-right-radius:2px}
.other{align-self:flex-start;background:#eee;color:#333;border-bottom-left-radius:2px}
.sender{font-size:11px;opacity:0.8;margin-bottom:4px;font-weight:bold}

/* INPUT AREA */
.input{display:flex;padding:15px;border-top:1px solid #eee}
input{flex:1;padding:12px;border:1px solid #ddd;border-radius:20px;outline:none}
input:focus{border-color:#667eea}
button.send-btn{margin-left:10px;padding:0 20px;background:#667eea;color:white;border:none;border-radius:20px;cursor:pointer;font-weight:bold}
button.send-btn:hover{background:#5a67d8}
</style>
</head>
<body>

<script>
const username = localStorage.getItem("username");
const logged = localStorage.getItem("logged");
if(!username || logged !== "true") location = "login.html";
</script>

<div class="app">
    <div class="sidebar">
        <div>
            <ul id="rooms">
                <li class="active" onclick="switchRoom('general')">ğŸ’¬ General</li>
                <li onclick="switchRoom('study')">ğŸ“š GÃ³c há»c táº­p</li>
                <li onclick="switchRoom('game')">ğŸ® Game</li>
            </ul>
        </div>
        
        <button class="logout-btn" onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
    </div>

    <div class="chat">
        <div class="header">
            ğŸ‘¤ <b><span id="user">...</span></b> | 
            ğŸ“Œ PhÃ²ng: <b><span id="room">...</span></b> | 
            ğŸŸ¢ Online: <span id="online">0</span>
        </div>

        <div class="messages" id="messages"></div>

        <div class="input">
            <input id="msg" placeholder="Nháº­p tin nháº¯n..." autofocus>
            <button class="send-btn" onclick="send()">Gá»­i â¤</button>
        </div>
    </div>
</div>

<script>
// --- KHá»I Táº O ---
document.getElementById("user").innerText = username;
let room = localStorage.getItem("room") || "general";
let ws = new WebSocket("ws://localhost:8765");
let store = {};

// Cáº­p nháº­t tÃªn phÃ²ng hiá»ƒn thá»‹
function updateRoomName(r){
    let display = r;
    if(r==='general') display = 'General';
    if(r==='study') display = 'GÃ³c há»c táº­p';
    if(r==='game') display = 'Game';
    document.getElementById("room").innerText = display;
}
updateRoomName(room);

// --- WEBSOCKET ---
ws.onopen = ()=>{
    ws.send(JSON.stringify({ type:"login", username, room }));
};

ws.onmessage = e=>{
    const d = JSON.parse(e.data);

    if(d.type === "login_success" || d.type === "switched"){
        store[room] = d.history || [];
        document.getElementById("online").innerText = d.online;
        render();
    }

    if(d.type === "message"){
        if(!store[d.room]) store[d.room] = [];
        store[d.room].push({ sender: d.sender, message: d.message });
        if(d.room === room) add(d.sender, d.message);
    }

    if(d.type === "online"){
        document.getElementById("online").innerText = d.online;
    }
};

// --- HÃ€M Xá»¬ LÃ ---
function add(sender, text){
    const div = document.createElement("div");
    div.className = "message " + (sender === username ? "me":"other");
    // Náº¿u lÃ  ngÆ°á»i khÃ¡c gá»­i thÃ¬ hiá»‡n tÃªn, mÃ¬nh gá»­i thÃ¬ áº©n tÃªn cho Ä‘áº¹p
    let content = sender === username ? `<div>${text}</div>` : `<div class="sender">${sender}</div><div>${text}</div>`;
    div.innerHTML = content;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function render(){
    messages.innerHTML="";
    (store[room]||[]).forEach(m=>add(m.sender,m.message));
}

function send(){
    const t = msg.value.trim();
    if(!t) return;
    ws.send(JSON.stringify({ type:"message", message:t }));
    msg.value="";
    msg.focus();
}

// Enter Ä‘á»ƒ gá»­i
msg.addEventListener("keydown",e=>{ if(e.key==="Enter") send(); });

function switchRoom(r){
    if(r===room) return;
    room=r;
    localStorage.setItem("room",r);
    updateRoomName(r);
    
    ws.send(JSON.stringify({type:"switch_room",room:r}));
    
    // Äá»•i mÃ u menu
    document.querySelectorAll(".sidebar li").forEach(li=>li.classList.remove("active"));
    const map = {'general':0, 'study':1, 'game':2}; // Map index Ä‘Æ¡n giáº£n
    document.querySelectorAll(".sidebar li")[map[r]].classList.add("active");
}

// --- HÃ€M ÄÄ‚NG XUáº¤T ---
function logout(){
    if(confirm("Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t?")){
        localStorage.clear(); // XÃ³a token/user
        ws.close(); // Ngáº¯t káº¿t ná»‘i
        location = "login.html"; // Quay vá» trang login
    }
}
</script>

</body>
</html>