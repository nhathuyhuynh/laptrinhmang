<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chat</title>

<style>
body{
    margin:0;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    background:linear-gradient(135deg,#667eea,#764ba2);
    font-family:sans-serif;
}
.app{
    width:900px;
    height:550px;
    background:white;
    display:flex;
    border-radius:12px;
    overflow:hidden;
}
.sidebar{
    width:200px;
    background:#f3f4f6;
    padding:10px;
}
.sidebar li{
    list-style:none;
    padding:10px;
    cursor:pointer;
    border-radius:6px;
}
.sidebar li.active{
    background:#667eea;
    color:white;
}
.chat{
    flex:1;
    display:flex;
    flex-direction:column;
}
.header{
    padding:10px;
    background:#667eea;
    color:white;
}
.messages{
    flex:1;
    padding:10px;
    display:flex;
    flex-direction:column;
    overflow-y:auto;
}
.message{
    max-width:60%;
    padding:10px;
    border-radius:12px;
    margin-bottom:8px;
}
.me{
    align-self:flex-end;
    background:#667eea;
    color:white;
}
.other{
    align-self:flex-start;
    background:#eee;
}
.sender{
    font-size:12px;
    opacity:.7;
}
.input{
    display:flex;
    padding:10px;
}
input{flex:1}
</style>
</head>

<body>

<script>
const username = localStorage.getItem("username");
if(!username){
    alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
    location = "login.html";
}
</script>

<div class="app">

<div class="sidebar">
<ul id="rooms">
<li class="active" onclick="switchRoom('general')">general</li>
<li onclick="switchRoom('study')">study</li>
<li onclick="switchRoom('game')">game</li>
</ul>
</div>

<div class="chat">
<div class="header">
ðŸ‘¤ <b id="user"></b> |
ðŸ“Œ <b id="room"></b> |
ðŸ‘¥ <span id="online">0</span>
</div>

<div class="messages" id="messages"></div>

<div class="input">
<input id="msg" placeholder="Enter message">
<button onclick="send()">Send</button>
</div>
</div>

</div>


<script>
    const username = localStorage.getItem("username");

if (!username) {
    alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
    location.href = "login.html";
}
document.getElementById("user").innerText = username;
let room = localStorage.getItem("room") || "general";
document.getElementById("room").innerText = room;

let ws = new WebSocket("ws://localhost:8765");
let store = {};


ws.onopen = ()=>{
    ws.send(JSON.stringify({
        type:"login",
        username,
        room
    }));
};

ws.onmessage = e=>{
    const d = JSON.parse(e.data);

    if(d.type === "login_success" || d.type === "switched"){
        store[room] = d.history || [];
        document.getElementById("online").innerText = d.online;
        render();
    }

    if(d.type === "message"){
        if(!store[d.room]) store[d.room]=[];
        store[d.room].push(d);
        if(d.room === room) add(d.sender, d.message);
    }

    if(d.type === "online"){
        document.getElementById("online").innerText = d.online;
    }
};

function add(sender, text){
    const div = document.createElement("div");
    div.className = "message " + (sender === username ? "me":"other");
    div.innerHTML = `<div class="sender">${sender}</div><div>${text}</div>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function render(){
    messages.innerHTML="";
    (store[room]||[]).forEach(m=>add(m.sender,m.message));
}

function send(){
    const t = msg.value.trim();
    if(!t) return;
    ws.send(JSON.stringify({
        type:"message",
        message:t
    }));
    msg.value="";
}

msg.addEventListener("keydown",e=>{
    if(e.key==="Enter") send();
});

function switchRoom(r){
    if(r===room) return;
    room=r;
    localStorage.setItem("room",r);
    document.getElementById("room").innerText=r;
    ws.send(JSON.stringify({type:"switch_room",room:r}));
    document.querySelectorAll(".sidebar li").forEach(li=>li.classList.remove("active"));
    [...document.querySelectorAll(".sidebar li")].find(li=>li.innerText===r)?.classList.add("active");
}
</script>

</body>
</html>
