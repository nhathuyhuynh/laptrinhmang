<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ph√≤ng Chat</title>
<style>
/* --- CSS C∆† B·∫¢N --- */
body{margin:0;height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#1e3c72,#2a5298);font-family:'Segoe UI',sans-serif}
.app{width:900px;height:600px;background:white;display:flex;border-radius:12px;overflow:hidden;box-shadow:0 0 20px rgba(0,0,0,0.3)}

/* --- SIDEBAR --- */
.sidebar{width:220px;background:#f1f2f6;padding:15px;display:flex;flex-direction:column;border-right:1px solid #ddd}
.room-list{flex:1;overflow-y:auto;margin-bottom:10px}
.room-list li{padding:10px;cursor:pointer;border-radius:6px;margin-bottom:5px;font-weight:500;color:#555;transition:0.2s}
.room-list li:hover{background:#dfe4ea}
.room-list li.active{background:#1e3c72;color:white}
.add-room input{width:100%;padding:8px;border:1px solid #ccc;border-radius:5px;margin-bottom:10px}
.logout-btn{background:#ff4757;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;width:100%;font-weight:bold}

/* --- CHAT AREA --- */
.chat{flex:1;display:flex;flex-direction:column;background:#fff}
.header{padding:15px;background:#1e3c72;color:white;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.1)}

/* MESSAGE LIST */
.messages{flex:1;padding:20px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;background:#f8f9fa}

/* BUBBLE CHAT */
.message-container { display: flex; flex-direction: column; max-width: 70%; }
.message-container.me { align-self: flex-end; align-items: flex-end; }
.message-container.other { align-self: flex-start; align-items: flex-start; }

.bubble {
    padding: 10px 14px; border-radius: 15px; font-size: 14px; line-height: 1.4; word-wrap: break-word;
    position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.me .bubble { background: #1e3c72; color: white; border-bottom-right-radius: 2px; }
.other .bubble { background: #e9ecef; color: #333; border-bottom-left-radius: 2px; }

/* ·∫¢NH G·ª¨I ƒêI */
.bubble img { max-width: 100%; border-radius: 8px; display: block; cursor: pointer;}
.sender-name { font-size: 11px; margin-bottom: 3px; color: #666; font-weight: bold; margin-left: 5px;}
.time-stamp { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; display: block;}

/* --- INPUT AREA --- */
.input-area{border-top:1px solid #eee;padding:10px;background:white}
.emoji-bar { margin-bottom: 5px; display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px;}
.emoji-btn { background: none; border: none; cursor: pointer; font-size: 18px; transition: transform 0.2s;}
.emoji-btn:hover { transform: scale(1.3); }

.input-row { display: flex; align-items: center; gap: 10px; }
input#msg { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
input#msg:focus { border-color: #1e3c72; }

/* N√∫t g·ª≠i ·∫£nh & G·ª≠i tin */
.icon-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; color: #555;}
.icon-btn:hover { background: #ddd; }
.send-btn { background: #1e3c72; color: white; padding: 0 20px; height: 40px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
.send-btn:hover { background: #162b55; }
</style>
</head>
<body>

<input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect()">

<script>
// Check login
const username = sessionStorage.getItem("username");
const logged = sessionStorage.getItem("logged");
if(!username || logged !== "true") location = "login.html";
</script>

<div class="app">
    <div class="sidebar">
        <h3 style="color:#1e3c72">üí¨ Chat App</h3>
        <div class="add-room">
            <input id="newRoomName" placeholder="T√™n ph√≤ng..." onkeydown="if(event.key==='Enter') createRoom()">
        </div>
        <div class="room-list">
            <ul id="rooms">
                <li class="active" onclick="switchRoom('general')"># general</li>
                <li onclick="switchRoom('study')"># study</li>
                <li onclick="switchRoom('game')"># game</li>
            </ul>
        </div>
        <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    </div>

    <div class="chat">
        <div class="header">
            <span>üìå <b id="roomNameDisplay">...</b></span>
            <span style="font-size:14px">üë§ <b id="user">...</b> | üü¢ <span id="online">0</span></span>
        </div>

        <div class="messages" id="messages"></div>

        <div class="input-area">
            <div class="emoji-bar">
                <button class="emoji-btn" onclick="addEmoji('üòÄ')">üòÄ</button>
                <button class="emoji-btn" onclick="addEmoji('üòÇ')">üòÇ</button>
                <button class="emoji-btn" onclick="addEmoji('üòç')">üòç</button>
                <button class="emoji-btn" onclick="addEmoji('üëç')">üëç</button>
                <button class="emoji-btn" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="emoji-btn" onclick="addEmoji('üò≠')">üò≠</button>
                <button class="emoji-btn" onclick="addEmoji('üò°')">üò°</button>
                <button class="emoji-btn" onclick="addEmoji('üéâ')">üéâ</button>
            </div>

            <div class="input-row">
                <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="G·ª≠i ·∫£nh">üìé</button>
                <input id="msg" placeholder="Nh·∫≠p tin nh·∫Øn..." autofocus>
                <button class="send-btn" onclick="send()">G·ª≠i ‚û§</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("user").innerText = username;
    let room = sessionStorage.getItem("room") || "general";
    const ws = new WebSocket("ws://localhost:8765");
    
    // UI Elements
    const msgList = document.getElementById("messages");
    const msgInput = document.getElementById("msg");

    // UI Helpers
    function updateRoomUI(r) {
        document.getElementById("roomNameDisplay").innerText = r;
        
        // Highlight ph√≤ng hi·ªán t·∫°i
        document.querySelectorAll(".room-list li").forEach(li => li.classList.remove("active"));
        let exist = [...document.querySelectorAll(".room-list li")].find(li => li.innerText === "# " + r);
        if(exist) {
            exist.classList.add("active");
        } else {
            const ul = document.getElementById("rooms");
            const li = document.createElement("li");
            li.innerText = "# " + r;
            li.onclick = () => switchRoom(r);
            li.classList.add("active");
            ul.prepend(li);
        }
    }

    // --- WEBSOCKET ---
    ws.onopen = () => {
        // G·ª≠i l·ªánh Login ngay khi k·∫øt n·ªëi
        ws.send(JSON.stringify({
            type: "login",
            username: username,
            room: room
        }));
        updateRoomUI(room);
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // 1. X·ª≠ l√Ω Login Success & Chuy·ªÉn ph√≤ng
        if (data.type === "login_success" || data.type === "switched") {
            if (data.room) room = data.room;
            document.getElementById("online").innerText = data.online;

            // X√≥a chat c≈© v√† hi·ªán l·ªãch s·ª≠
            msgList.innerHTML = "";
            if (data.history) {
                data.history.forEach(m => add(m.sender, m.message, m.time));
            }
        }

        // 2. Nh·∫≠n tin nh·∫Øn m·ªõi
        if (data.type === "message") {
            add(data.sender, data.message, data.time);
        }

        // 3. C·∫≠p nh·∫≠t Online
        if (data.type === "online") {
            document.getElementById("online").innerText = data.online;
        }
    };

    // --- HI·ªÇN TH·ªä TIN NH·∫ÆN ---
    function add(sender, content, time) {
        if (!time) {
            let d = new Date();
            time = d.getHours() + ":" + String(d.getMinutes()).padStart(2, '0');
        }

        const container = document.createElement("div");
        container.className = "message-container " + (sender === username ? "me" : "other");

        let bubbleContent = "";
        // Ki·ªÉm tra ·∫£nh
        if (content.startsWith("data:image")) {
            bubbleContent = `<img src="${content}" onclick="window.open(this.src)">`;
        } else {
            bubbleContent = `<div>${content}</div>`;
        }

        let nameHTML = sender === username ? "" : `<div class="sender-name">${sender}</div>`;

        container.innerHTML = `
            ${nameHTML}
            <div class="bubble">
                ${bubbleContent}
                <span class="time-stamp">${time}</span>
            </div>
        `;
        msgList.appendChild(container);
        msgList.scrollTop = msgList.scrollHeight;
    }

    // --- G·ª¨I TIN ---
    function send() {
        const t = msgInput.value.trim();
        if (!t) return;
        ws.send(JSON.stringify({ type: "message", message: t }));
        msgInput.value = "";
        msgInput.focus();
    }
    msgInput.addEventListener("keydown", e => { if (e.key === "Enter") send(); });

    // --- G·ª¨I ·∫¢NH ---
    function handleFileSelect() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) return alert("·∫¢nh < 2MB th√¥i b·∫°n ∆°i!");

        const reader = new FileReader();
        reader.onload = function(e) {
            ws.send(JSON.stringify({ type: "message", message: e.target.result }));
        };
        reader.readAsDataURL(file);
        document.getElementById('fileInput').value = '';
    }

    // --- TI·ªÜN √çCH ---
    function addEmoji(emoji) {
        msgInput.value += emoji;
        msgInput.focus();
    }

    function switchRoom(r) {
        if (r === room) return;
        room = r;
        sessionStorage.setItem("room", r);
        updateRoomUI(r);
        ws.send(JSON.stringify({ type: "switch_room", room: r }));
    }

    function createRoom() {
        const val = document.getElementById("newRoomName").value.trim();
        if (!val) return;
        const name = val.toLowerCase().replace(/\s+/g, '-');
        if (name === room) return;
        switchRoom(name);
        document.getElementById("newRoomName").value = "";
    }

    function logout() {
        if (confirm("ƒêƒÉng xu·∫•t nh√©?")) {
            sessionStorage.clear();
            ws.close();
            location = "login.html";
        }
    }
</script>

</body>
</html>